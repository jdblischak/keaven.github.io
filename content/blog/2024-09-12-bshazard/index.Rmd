---
title: "Smoothing hazard rates and survival curves with bshazard"
author: Keaven Anderson, Nan Xiao
date: "2024-09-12"
slug: "bshazard"
tags:
  - simtrial
  - clinical trial simulation
  - time-to-event
description: >
    TBA...
bibliography: "bshazard.bib"
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  out.width = "70%",
  fig.align = "center"
)
```

## Introduction

The [bshazard](https://cran.r-project.org/package=bshazard) R package [@rebora2014bshazard] is available on CRAN since 2014.
It might be useful where there is interest in where smoothed hazard rates cross.
When there are excess in one arm early and and excess in the other arm late, the time at which (smoothed) hazard rates cross can come well before the time when Kaplan-Meier survival curves cross.
The time at which hazard rates cross is probably a more important demarcation for the period of early excess risk than the time at which survival curves cross.

As noted by @rebora2014bshazard, another alternative is the [flexsurv](https://cran.r-project.org/package=flexsurv) package for comparison [@jackson2016flexsurv].
The bshazard package has no unit testing included, but we have found the model checking procedure described below adequate to justify use of the package. This sort of model checking is likely to be recommended regardless of how hazard rates are estimated.

```{r, message=FALSE, warning=FALSE}
library(bshazard)
library(simtrial)
library(dplyr)
library(survival)
library(ggsurvfit)
```

```{r, message=FALSE, warning=FALSE}
# Crossing survival curves example from simtrial
data(ex6_crossing)
```

```{r}
# Set theme and color scales globally
ggplot2::theme_set(cowplot::theme_cowplot())

scale_color <- function(...) ggplot2::scale_color_manual(values = c("#e15759", "#4e79a7"), ...)
scale_fill <- function(...) ggplot2::scale_fill_manual(values = c("#e15759", "#4e79a7"), ...)
options(ggplot2.discrete.colour = scale_color)
options(ggplot2.discrete.fill = scale_fill)
```

## Example

For the following survival curves based on reverse engineered survival data from the [simtrial](https://merck.github.io/simtrial/) package, the estimated Kaplan-Meier curves cross between 10 and 11 months.
However, we see that the widest gap between the survival curves may have been around 3 months, with the curves converging thereafter.
We will evaluate this further using B-spline smoothed hazard rate estimates in the next section.

```{r}
pl <- survfit2(Surv(month, evntd) ~ trt, data = ex6_crossing)
p <- pl |>
  ggsurvfit(theme = cowplot::theme_cowplot()) +
  scale_x_continuous(breaks = seq(0, 27, 3)) +
  # add_confidence_interval() +
  add_risktable(risktable_stats = "n.risk") +
  theme(legend.position = "bottom") +
  scale_color_discrete(labels = c("Control", "Treatment"))
p
```

## Smoothed hazard rate estimates

We apply the bshazard R package to smooth the hazard rate over time within each treatment group.
Here we used the default `nk = 31` knots for smoothing.
The help file suggests a maximum of `nk = 40`, but higher values can be used to see behavior induced by the `nk` parameter. For instance increasing to `nk = 120` likely will give a much less smooth curve.
Thus, this selecting this parameter can be a bit of an art given the descriptive nature of the analysis.

```{r, results="hide"}
fit <- bshazard(Surv(month, evntd) ~ 1, data = subset(ex6_crossing, trt == 0), nk = 31)
fit2 <- bshazard(Surv(month, evntd) ~ 1, data = subset(ex6_crossing, trt == 1), nk = 31)
```

We plot the hazard rates with confidence bands by treatment group.

```{r, warning=FALSE}
haz <- bind_rows(
  data.frame(
    Month = fit$time, Hazard = fit$hazard, Treatment = "Control",
    lower.ci = fit$lower.ci, upper.ci = fit$upper.ci
  ),
  data.frame(
    Month = fit2$time, Hazard = fit2$hazard, Treatment = "Experimental",
    lower.ci = fit2$lower.ci, upper.ci = fit2$upper.ci
  )
)

ggplot(haz, aes(Month)) +
  geom_line(aes(y = Hazard, col = Treatment)) +
  geom_ribbon(aes(ymin = lower.ci, ymax = upper.ci, fill = Treatment), alpha = 0.2, linetype = 0) +
  scale_x_continuous(breaks = (0:5) * 6) +
  ylab("Hazard rate") +
  ylim(0, 0.1) +
  theme(legend.position = "bottom")
```

### Compare smoothed to actual survival function

While bshazard has been published [@rebora2014bshazard], it is relatively new and this is worth checking the model fit.
For this purpose, we transform the smoothed hazard rate estimates to survival curves and compare to the Kaplan-Meier curves previously estimated.
The Kaplan-Meier curves are reproduced accurately by the smoothed estimate for each treatment group.
We noted previously that the Kaplan-Meier curves crossed after 10 months for the treatment groups.
For hazard rates, we see the crossing of observed curves is before 6 months, suggesting a different interpretation of when an excess risk period ends for the experimental group compared to control.

```{r}
# Get smoothed survival estimate
pl2 <- haz |>
  group_by(Treatment) |>
  mutate(
    CHaz = cumsum((Month - lag(Month, default = 0)) * Hazard),
    Survival = exp(-CHaz), Estimate = "Smoothed"
  ) |>
  select(Survival, Month, Treatment, Estimate)

# Get Kaplan-Meier data from plots
km <- p$data |>
  as.data.frame() |>
  transmute(
    Survival = estimate,
    Month = time,
    Treatment = ifelse(strata == 1, "Experimental", "Control"),
    Estimate = "Kaplan-Meier"
  )

# Combine and plot
ggplot(bind_rows(pl2, km), aes(x = Month, y = Survival, col = Treatment, lty = Estimate)) +
  geom_line() +
  scale_x_continuous(breaks = (0:6) * 6) +
  ylab("Survival") +
  ggtitle("Smoothed vs. Kaplan-Meier Survival Estimates") +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 11)
  ) +
  guides(color = guide_legend(order = 1), linetype = guide_legend(order = 2))
```

The following example draws the Kaplan-Meier curve as a step function.

```{r}
pl |>
  ggsurvfit(theme = cowplot::theme_cowplot()) +
  scale_x_continuous(breaks = seq(0, 27, 3)) +
  geom_line(
    data = pl2 |> filter(Treatment == "Experimental"),
    aes(x = Month, y = Survival),
    col = "#00857C", linetype = "dashed", inherit.aes = FALSE
  ) +
  geom_line(
    data = pl2 |> filter(Treatment == "Control"),
    aes(x = Month, y = Survival),
    col = "#66203A", linetype = "dashed", inherit.aes = FALSE
  ) +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 11)
  ) +
  scale_color_discrete(labels = c("Control", "Treatment")) +
  ggtitle("Smoothed vs. Kaplan-Meier Survival Estimates") +
  xlab("Month") +
  ylab("Survival") +
  # Add a legend for linetype
  geom_line(
    data = data.frame(
      x = c(0, 0, 0, 0), y = c(0, 0, 0, 0),
      Estimate = factor(rep(c("Kaplan-Meier", "Smoothed"), 2))
    ),
    aes(x = x, y = y, linetype = Estimate), inherit.aes = FALSE
  ) +
  guides(
    color = guide_legend(title = "Treatment"),
    linetype = guide_legend(title = "Estimate")
  )
```

## Session info

```{r, echo=FALSE}
pkgs <- sessioninfo::session_info(info = "packages")
pkgs$packages$library <- NULL
pkgs
```

## References
